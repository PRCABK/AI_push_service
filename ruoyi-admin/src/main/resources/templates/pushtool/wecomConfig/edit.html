<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org">
<head>
    <th:block th:include="include :: header('编辑推送平台配置')" />
</head>
<body class="white-bg">
<div class="wrapper wrapper-content animated fadeInRight ibox-content">
    <form class="form-horizontal m" id="form-wecomConfig-edit" th:object="${sysWecomConfig}">
        <input name="id" th:field="*{id}" type="hidden">
        <div class="form-group">
            <label class="col-sm-3 control-label is-required">配置名称：</label>
            <div class="col-sm-8">
                <input name="configName" th:field="*{configName}" class="form-control" type="text" required>
            </div>
        </div>
        <div class="form-group">
            <label class="col-sm-3 control-label is-required">企业ID：</label>
            <div class="col-sm-8">
                <input name="corpId" th:field="*{corpId}" class="form-control" type="text" required>
            </div>
        </div>
        <div class="form-group">
            <label class="col-sm-3 control-label is-required">Secret：</label>
            <div class="col-sm-8">
                <input name="secret" th:field="*{secret}" class="form-control" type="password" required autocomplete="off">
            </div>
        </div>
        <div class="form-group">
            <label class="col-sm-3 control-label is-required">AgentId：</label>
            <div class="col-sm-8">
                <input name="agentId" th:field="*{agentId}" class="form-control" type="number" min="1" required>
            </div>
        </div>
        <div class="form-group">
            <label class="col-sm-3 control-label">默认接收人：</label>
            <div class="col-sm-8">
                <input name="defaultUser" th:field="*{defaultUser}" class="form-control" type="text" placeholder="多个UserID使用 | 分隔">
            </div>
        </div>
        <div class="form-group">
            <label class="col-sm-3 control-label">默认部门：</label>
            <div class="col-sm-8">
                <input name="defaultParty" th:field="*{defaultParty}" class="form-control" type="text">
            </div>
        </div>
        <div class="form-group">
            <label class="col-sm-3 control-label">默认消息类型：</label>
            <div class="col-sm-8">
                <select name="defaultMsgType" class="form-control" th:field="*{defaultMsgType}">
                    <option value="text">文本消息</option>
                    <option value="textcard">文本卡片</option>
                </select>
            </div>
        </div>

        <div class="form-group">
            <label class="col-sm-3 control-label">接收人分组：</label>
            <div class="col-sm-8">
                <input type="hidden" name="receiverGroups" id="receiverGroups" th:field="*{receiverGroups}">
                <table class="table table-bordered" id="receiverGroupTable">
                    <thead>
                    <tr>
                        <th style="width: 30%">分组名称</th>
                        <th>成员UserID（| 分隔）</th>
                        <th style="width: 80px;">操作</th>
                    </tr>
                    </thead>
                    <tbody id="receiverGroupBody"></tbody>
                </table>
                <a class="btn btn-primary btn-xs" onclick="addGroupRow()"><i class="fa fa-plus"></i> 新增分组</a>
            </div>
        </div>

        <div class="form-group">
            <label class="col-sm-3 control-label">文本模板：</label>
            <div class="col-sm-8">
                <textarea name="textTemplate" th:field="*{textTemplate}" class="form-control" rows="4"></textarea>
            </div>
        </div>
        <div class="form-group">
            <label class="col-sm-3 control-label">卡片标题模板：</label>
            <div class="col-sm-8">
                <input name="cardTitleTemplate" th:field="*{cardTitleTemplate}" class="form-control" type="text">
            </div>
        </div>
        <div class="form-group">
            <label class="col-sm-3 control-label">卡片正文模板：</label>
            <div class="col-sm-8">
                <textarea name="cardContentTemplate" th:field="*{cardContentTemplate}" class="form-control" rows="4"></textarea>
            </div>
        </div>
        <div class="form-group">
            <label class="col-sm-3 control-label">卡片跳转链接：</label>
            <div class="col-sm-8">
                <input name="cardUrlTemplate" th:field="*{cardUrlTemplate}" class="form-control" type="text">
            </div>
        </div>
        <div class="form-group">
            <label class="col-sm-3 control-label">卡片按钮文字：</label>
            <div class="col-sm-8">
                <input name="cardBtnText" th:field="*{cardBtnText}" class="form-control" type="text">
            </div>
        </div>
        <div class="form-group">
            <label class="col-sm-3 control-label">备注：</label>
            <div class="col-sm-8">
                <textarea name="remark" th:field="*{remark}" class="form-control" rows="2"></textarea>
            </div>
        </div>
    </form>
</div>
<th:block th:include="include :: footer" />
<script th:inline="javascript">
    var prefix = ctx + "pushtool/wecomConfig";

    function addGroupRow(name, users) {
        var tr = $('<tr>');
        tr.append('<td><input type="text" class="form-control group-name" value="' + (name || '') + '"></td>');
        tr.append('<td><input type="text" class="form-control group-users" value="' + (users || '') + '" placeholder="userA|userB"></td>');
        tr.append("<td class='text-center'><a class='btn btn-danger btn-xs' onclick='$(this).closest(\"tr\").remove()'><i class='fa fa-trash'></i> 删除</a></td>");
        $('#receiverGroupBody').append(tr);
    }

    function initGroupRows() {
        var raw = /*[[${sysWecomConfig.receiverGroups}]]*/ '';
        if (raw) {
            try {
                var list = JSON.parse(raw);
                if (Array.isArray(list) && list.length) {
                    list.forEach(function(item){
                        addGroupRow(item.name, item.users);
                    });
                    return;
                }
            } catch (e) {
                console.warn('解析receiverGroups失败', e);
            }
        }
        addGroupRow();
    }

    function collectGroupPayload() {
        var groups = [];
        $('#receiverGroupBody tr').each(function () {
            var name = $(this).find('.group-name').val();
            var users = $(this).find('.group-users').val();
            if (name && users) {
                groups.push({name: name, users: users});
            }
        });
        $('#receiverGroups').val(groups.length ? JSON.stringify(groups) : '');
    }

    function submitHandler() {
        if ($.validate.form()) {
            collectGroupPayload();
            $.operate.save(prefix + "/edit", $('#form-wecomConfig-edit').serialize());
        }
    }

    $(function () {
        initGroupRows();
    });
</script>
</body>
</html>
